package com.weather.forcast.service.impl;

import java.time.LocalDate;
import java.util.*;
import java.util.stream.Collector;
import java.util.stream.Collectors;import java.util.stream.Stream;

import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;

import com.weather.forcast.dto.MonthlyTemperatureDTO;
import com.weather.forcast.dto.WeatherResponseDTO;
import com.weather.forcast.entity.WeatherData;
import com.weather.forcast.repository.WeatherRepository;
import com.weather.forcast.service.WeatherService;
import com.weather.forcast.util.CsvUtil;

import lombok.RequiredArgsConstructor;

@Service
@RequiredArgsConstructor
public class WeatherServiceImpl implements WeatherService{
	private final WeatherRepository weatherRepository;
	@Override
	public void uploadCsv(MultipartFile file) {
		try {
			List<WeatherData> data=CsvUtil.parse(file.getInputStream());
			weatherRepository.saveAll(data);
		} catch (Exception e) {
			throw new RuntimeException("CSV upload failed");
		}
	}
	@Override
	public List<WeatherResponseDTO> getWeatherByDate(LocalDate date){
		return weatherRepository.findByDate(date)
				.stream()
				.map(data->WeatherResponseDTO.builder()
						.weatherCondition(data.getWeatherCondition())
						.temperature(data.getTemperature())
						.humidity(data.getHumidity())
						.pressure(data.getPressure())
						.build())
				.collect(Collectors.toList());
	}
	 @Override
	    public List<WeatherResponseDTO> getWeatherByMonth(int month) {
	        return WeatherRepository.findByDateMonth(month)
	        		.stream()
					.map(data->WeatherResponseDTO.builder()
							.weatherCondition(data.getWeatherCondition())
							.temperature(data.getTemperature())
							.humidity(data.getHumidity())
							.pressure(data.getPressure())
							.build())
					.collect(Collectors.toList());
	    }
	@Override
	public List<MonthlyTemperatureDTO> getYearlyStats(int year) {
		List<WeatherData> yearlyData=weatherRepository.findByYear(year);
		Map<Integer, List<WeatherData>> groupByMonth=
				yearlyData.stream()
				.collect(Collector.groupingBy(d->d.getDate().getMonthValue()));
		List<MonthlyTemperatureDTO> stats= new ArrayList<>();
		for (Map.Entry<Integer, List<WeatherData>> entry : groupByMonth.entrySet()) {
			List<Double> temps=entry.getValue()
					.stream()
					.map()
		}
	}
	
}
